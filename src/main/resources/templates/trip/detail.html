<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${event.title} + ' - 신청'">Trip Detail</title>

    <!-- detail.html 전용 CSS -->
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            text-align: center;
        }

        .page-container {
            max-width: 900px;
            margin: 30px auto;
            padding: 0 20px;
        }

        table {
            margin: 20px auto;
            border-collapse: collapse;
            width: 80%;
        }

        th, td {
            padding: 10px;
            border: 1px solid #aaa;
            text-align: center;
        }

        h1 {
            margin-top: 30px;
        }

        button, a {
            margin-top: 20px;
        }

        /* 모달 */
        .modal { 
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }
        .modal .box {
            width: 80%;
            height: 70%;
            background: white;
            padding: 10px;
        }
		
		/* 신청 버튼을 텍스트 링크처럼 보이도록 변경 */
		#applyBtn {
		    background: none;
		    border: none;
		    color: #0066cc;
		    font-weight: bold;
		    font-size: 1em;
		    cursor: pointer;
		    padding: 0;
		    margin-right: 15px;
		    text-decoration: none;
			font-size: 1.5em;
		}

		/* 신청현황 보기 링크 스타일 */
		.link-btn {
		    text-decoration: none;
		    color: #0066cc;
		    font-weight: bold;
			font-size: 1.5em;
		}
		
    </style>
</head>

<body>

<!-- fragment/header.html을 그대로 적용 -->
<header th:replace="fragment/header :: headerDiv"></header>

<div class="page-container">

    <h1 th:text="${event.title}">대회명</h1>

    <table>
        <tr>
            <td><b>대회명</b></td>
            <td th:text="${event.title}"></td>
        </tr>

        <tr>
            <td><b>출발지</b></td>
            <td>
                <span id="startName" th:text="${startCity}"></span>
				/
				<span>(버스정차위치)</span>
				<span th:text="${startCityAddr}"></span>
                <button id="btnStartMap">지도 보기</button>
            </td>
        </tr>

        <tr>
            <td><b>도착지</b></td>
            <td>
                <span id="endName" th:text="${endCity}"></span>
				/
				<span>(버스정차위치)</span>
				<span th:text="${endCityAddr}"></span>
                <button id="btnEndMap">지도 보기</button>
            </td>
        </tr>

        <tr>
            <td><b>일정</b></td>
            <td th:text="${#dates.format(startDate,'yyyy-MM-dd')} 
                         + ' ~ ' + 
                         ${#dates.format(endDate,'yyyy-MM-dd')}"></td>
        </tr>

        <tr>
            <td><b>거리 (km)</b></td>
            <td id="distanceCell"
                th:text="${trip != null ? trip.distance : '-'}">-</td>
        </tr>

        <tr>
            <td><b>비용 (인당)</b></td>
            <td id="costCell"
                th:text="${trip != null ? trip.cost : '-'}">-</td>
        </tr>

        <tr>
            <td><b>현재 신청인원</b></td>
            <td id="currentPeople"
                th:text="${trip != null && trip.currentPeople != null ? trip.currentPeople : 0}">0</td>
        </tr>

        <tr>
            <td><b>최소 출발인원</b></td>
            <td>25</td>
        </tr>

        <tr>
            <td><b>상태</b></td>
            <td id="statusCell"
                th:text="${trip != null ? trip.status : '-'}">-</td>
        </tr>
    </table>

    <button id="applyBtn">신청</button>
	<!-- 취소 버튼 -->
	<button id="cancelBtn" style="
		background: none;
		border: none;
		color: #ff3333;       /* 빨간색으로 구분 */
		font-weight: bold;
		font-size: 1.5em;
		cursor: pointer;
		margin-left: 15px;
		text-decoration: none;">
		취소
	</button>
    <a href="/trip/list" class="link-btn" style="margin-left: 15px;">신청현황 보기</a>

</div>

<!-- 지도 모달 -->
<div id="mapModal" class="modal">
  <div class="box">
    <div id="map" style="width:100%; height:100%;"></div>
    <button onclick="closeModal()">닫기</button>
  </div>
</div>

<script>
    document.getElementById("applyBtn").addEventListener("click", function () {

        if (!eventId) {
            alert("이벤트 정보가 올바르지 않습니다.");
            return;
        }
		
		if (!userId) {
		        alert("로그인이 필요합니다.");
		        return;
		    }

        if (confirm("정말 신청하시겠습니까?")) {

            fetch("/apply", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ event_id: eventId })
            })
            .then(res => res.json())
            .then(data => {
                alert(data.message);
                if (data.ok) {
					// 현재 인원수 갱신
                    document.getElementById("currentPeople").textContent = data.currentPeople;
					// 신청 버튼 비활성화
					document.getElementById("applyBtn").disabled = true;
					// 취소 버튼 활성화
					const cancelBtn = document.getElementById("cancelBtn");
					if (cancelBtn) cancelBtn.disabled = false;
                }
            })
            .catch(err => {
                alert("신청 중 오류 발생");
                console.error(err);
            });
        }
    });
	
	if (document.getElementById("cancelBtn")) {
	    document.getElementById("cancelBtn").addEventListener("click", function () {

	        if (!eventId) {
	            alert("여행 정보가 올바르지 않습니다.");
	            return;
	        }

	        if (!userId) {
	            alert("로그인이 필요합니다.");
	            return;
	        }

	        if (confirm("정말 신청을 취소하시겠습니까?")) {

	            fetch("/trip/cancel", {
	                method: "POST",
	                headers: { "Content-Type": "application/json" },
	                body: JSON.stringify({ eventId: eventId })   // userId 전송 X
	            })
	            .then(res => res.json())
	            .then(data => {
	                alert(data.message);

	                if (data.ok) {
	                    // 취소 성공 → 버튼 상태 변경
	                    document.getElementById("cancelBtn").disabled = true;
	                    document.getElementById("applyBtn").disabled = false;

	                    // 현재 인원 업데이트
	                    updateCurrentPeople(eventId);
	                }
	            })
	            .catch(err => {
	                alert("취소 중 오류 발생");
	                console.error(err);
	            });
	        }
	    });
	}
	
	// 현재 인원 갱신
	function updateCurrentPeople(eventId) {
    	fetch(`/trip/current-people/${eventId}`)
        	.then(res => res.json())
       		.then(data => {
            	document.getElementById("currentPeople").textContent = data.currentPeople;
        	})
        	.catch(err => console.error(err));
	}

</script>

<script th:inline="javascript">
/*<![CDATA[*/
    const startCity = /*[[${startCity}]]*/ '서울';
    const endCity   = /*[[${endCity}]]*/ '강릉';
    const eventId = /*[[${event.id}]]*/ 0;
    const userId  = /*[[${loginUser.userId}]]*/ '';
	const tripId = /*[[${trip != null ? trip.tripId : 0}]]*/ 0;
/*]]>*/
</script>

</body>
</html>
