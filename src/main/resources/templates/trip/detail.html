<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${event.title} + ' - 신청'">Trip Detail</title>

    <!-- detail.html 전용 CSS -->
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            text-align: center;
        }

        .page-container {
            max-width: 900px;
            margin: 30px auto;
            padding: 0 20px;
        }

        table {
            margin: 20px auto;
            border-collapse: collapse;
            width: 80%;
        }

        th, td {
            padding: 10px;
            border: 1px solid #aaa;
            text-align: center;
        }

        h1 {
            margin-top: 30px;
        }

        button, a {
            margin-top: 20px;
        }

        /* 모달 */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            z-index: 9999;
			
			align-items: center;
			justify-content: center;
        }
        .modal .box {
            width: 800px;
			max-width: 90%;
            height: 600px;
			background: #fff;
			border-radius: 8px;
			position: relative;
			display: flex;
			flex-direction: column;
        }
		/* 주소 영역 */
		#mapAddress {
			position: relative;      /* ⭐ 기준점 */
		    padding: 10px 14px;
		    font-weight: bold;
		    border-bottom: 1px solid #ddd;
		    text-align: left;
		}
		/* 지도 영역 */
		#map {
		    flex: 1;
		}
		/* 닫기 버튼 */
		.modal-close {
		    position: absolute;
		    top: 8px;
		    right: 12px;
		    background: none;
		    border: none;
		    font-size: 20px;
		    cursor: pointer;
		    z-index: 10000;
		}
		
		/* 신청 버튼을 텍스트 링크처럼 보이도록 변경 */
		#applyBtn {
		    background: none;
		    border: none;
		    color: #0066cc;
		    font-weight: bold;
		    font-size: 1em;
		    cursor: pointer;
		    padding: 0;
		    margin-right: 15px;
		    text-decoration: none;
			font-size: 1.5em;
		}

		/* 신청현황 보기 링크 스타일 */
		.link-btn {
		    text-decoration: none;
		    color: #0066cc;
		    font-weight: bold;
			font-size: 1.5em;
		}
		
    </style>
</head>

<body>

<!-- fragment/header.html을 그대로 적용 -->
<header th:replace="fragment/header :: headerDiv"></header>

<script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=43652f0566b534bd3247a96af0d13514&libraries=services"></script>


<div class="page-container">

    <h1 th:text="${event.title}">대회명</h1>

    <table>
        <tr>
            <td><b>대회명</b></td>
            <td th:text="${event.title}"></td>
        </tr>

        <tr>
            <td><b>출발지</b></td>
            <td>
                <span id="startName" th:text="${startCity}"></span>
				/
				<span>(버스정차위치)</span>
				<span th:text="${startCityAddr}"></span>
                <button onclick="openMapModal('start')">지도 보기</button>
            </td>
        </tr>

        <tr>
            <td><b>도착지</b></td>
            <td>
                <span id="endName" th:text="${endCity}"></span>
				/
				<span>(버스정차위치)</span>
				<span th:text="${endCityAddr}"></span>
                <button onclick="openMapModal('end')">지도 보기</button>
            </td>
        </tr>

        <tr>
            <td><b>일정</b></td>
			<td th:text="${#dates.format(startDate,'yyyy-MM-dd') == #dates.format(endDate,'yyyy-MM-dd')}
			             ? ${#dates.format(startDate,'yyyy-MM-dd')}
			             : ${#dates.format(startDate,'yyyy-MM-dd')} + ' ~ ' + ${#dates.format(endDate,'yyyy-MM-dd')}">
			</td>

        </tr>

        <tr>
            <td><b>거리 (km)</b></td>
            <td id="distanceCell"
                th:text="${trip != null ? trip.distance : '-'}">-</td>
        </tr>

        <tr>
            <td><b>비용 (인당)</b></td>
            <td id="costCell"
                th:text="${trip != null ? trip.cost : '-'}">-</td>
        </tr>

        <tr>
            <td><b>현재 신청인원</b></td>
            <td id="currentPeople"
                th:text="${trip != null && trip.currentPeople != null ? trip.currentPeople : 0}">0</td>
        </tr>

        <tr>
            <td><b>최소 출발인원</b></td>
            <td>25</td>
        </tr>

        <tr>
            <td><b>상태</b></td>
            <td id="statusCell"
                th:text="${trip != null ? trip.status : '-'}">-</td>
        </tr>
    </table>

    <button id="applyBtn">신청</button>
	<!-- 취소 버튼 -->
	<button id="cancelBtn" style="
		background: none;
		border: none;
		color: #ff3333;       /* 빨간색으로 구분 */
		font-weight: bold;
		font-size: 1.5em;
		cursor: pointer;
		margin-left: 15px;
		text-decoration: none;">
		취소
	</button>
    <a href="/trip/list" class="link-btn" style="margin-left: 15px;">신청현황 보기</a>

</div>

<!-- 지도 모달 : Modal UI (detail.html 하단), 발표용이면 Bootstrap Modal이 가장 무난 -->
<div id="mapModal" class="modal" onclick="closeMapModal()">
	<div class="box" onclick="event.stopPropagation()">
		<button class="modal-close" onclick="closeMapModal()">✕</button>
		<!-- 주소 표시 -->
		<div id="mapAddress">
		    버스정차 위치 :
		</div>
	<div id="map"></div>
	</div>
</div>

<script>
    document.getElementById("applyBtn").addEventListener("click", function () {

        if (!eventId) {
            alert("이벤트 정보가 올바르지 않습니다.");
            return;
        }
		
		if (!userId) {
		        alert("로그인이 필요합니다.");
		        return;
		    }

        if (confirm("정말 신청하시겠습니까?")) {

            fetch("/apply", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ event_id: eventId })
            })
            .then(res => res.json())
            .then(data => {
                alert(data.message);
                if (data.ok) {
					// 현재 인원수 갱신
                    document.getElementById("currentPeople").textContent = data.currentPeople;
					// 신청 버튼 비활성화
					document.getElementById("applyBtn").disabled = true;
					// 취소 버튼 활성화
					const cancelBtn = document.getElementById("cancelBtn");
					if (cancelBtn) cancelBtn.disabled = false;
                }
            })
            .catch(err => {
                alert("신청 중 오류 발생");
                console.error(err);
            });
        }
    });
	
	if (document.getElementById("cancelBtn")) {
	    document.getElementById("cancelBtn").addEventListener("click", function () {

	        if (!eventId) {
	            alert("여행 정보가 올바르지 않습니다.");
	            return;
	        }

	        if (!userId) {
	            alert("로그인이 필요합니다.");
	            return;
	        }

	        if (confirm("정말 신청을 취소하시겠습니까?")) {

	            fetch("/trip/cancel", {
	                method: "POST",
	                headers: { "Content-Type": "application/json" },
	                body: JSON.stringify({ eventId: eventId })   // userId 전송 X
	            })
	            .then(res => res.json())
	            .then(data => {
	                alert(data.message);

	                if (data.ok) {
	                    // 취소 성공 → 버튼 상태 변경
	                    document.getElementById("cancelBtn").disabled = true;
	                    document.getElementById("applyBtn").disabled = false;

	                    // 현재 인원 업데이트
	                    updateCurrentPeople(eventId);
	                }
	            })
	            .catch(err => {
	                alert("취소 중 오류 발생");
	                console.error(err);
	            });
	        }
	    });
	}
	
	// 현재 인원 갱신
	function updateCurrentPeople(eventId) {
    	fetch(`/trip/current-people/${eventId}`)
        	.then(res => res.json())
       		.then(data => {
            	document.getElementById("currentPeople").textContent = data.currentPeople;
        	})
        	.catch(err => console.error(err));
	}
	
	document.addEventListener("DOMContentLoaded", function () {

	    /* 거리 (km) : 소수점 제거 */
	    const distanceCell = document.getElementById("distanceCell");
	    if (distanceCell && distanceCell.textContent !== "-") {
	        const distance = parseFloat(distanceCell.textContent);
	        if (!isNaN(distance)) {
	            distanceCell.textContent = Math.floor(distance);
	        }
	    }
		
		/* 비용 (인당) : 천 단위 콤마 */
		const costCell = document.getElementById("costCell");
		if (costCell && costCell.textContent !== "-") {
		    const cost = parseInt(costCell.textContent, 10);
		    if (!isNaN(cost)) {
		        costCell.textContent = cost.toLocaleString("ko-KR");
		    }
		}

	});

</script>

<script th:inline="javascript">
/*<![CDATA[*/
    const startCity = /*[[${startCity}]]*/ '서울';
    const endCity   = /*[[${endCity}]]*/ '강릉';
	const startAddr = /*[[${startCityAddr}]]*/ '';
	const endAddr   = /*[[${endCityAddr}]]*/ '';
    const eventId = /*[[${event.id}]]*/ 0;
    const userId  = /*[[${loginUser.userId}]]*/ '';
	const tripId = /*[[${trip != null ? trip.tripId : 0}]]*/ 0;
/*]]>*/
</script>

<script>
function openMapModal(type) {
    const modal = document.getElementById("mapModal");
    modal.style.display = "flex";

    const address = (type === 'start') ? startAddr : endAddr;

    document.getElementById("mapAddress").innerText =
        "버스정차 위치 : " + address;

    setTimeout(() => {
        const mapContainer = document.getElementById("map");

        const map = new kakao.maps.Map(mapContainer, {
            center: new kakao.maps.LatLng(37.5665, 126.9780),
            level: 5
        });

        const geocoder = new kakao.maps.services.Geocoder();

        geocoder.addressSearch(address, function(result, status) {
            if (status === kakao.maps.services.Status.OK) {
                const coords = new kakao.maps.LatLng(result[0].y, result[0].x);

                new kakao.maps.Marker({
                    map: map,
                    position: coords
                });

                map.setCenter(coords);
            }
        });
    }, 200);
}

function closeMapModal() {
    document.getElementById("mapModal").style.display = "none";
}
</script>


</body>
</html>
