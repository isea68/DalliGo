<!DOCTYPE html>
<html lang="ko">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel ="stylesheet" href="/css/JYList.css">
	<title>커뮤니티</title>
</head>

<body>

	<div th:replace="fragment/header :: headerDiv"></div>

	<!-- header-->
	<div id="mainboard">커뮤니티</div>


	<!-- 네비게이션 메뉴 -->
	<div id="nav-box">
		<nav>
			<input type="hidden" id="currentCategory" th:value="${category}">
			<div class="nav-item">
				<a id="info" class="category-btn" data-category="info">러닝정보/노하우</a>
			</div>
			<div class="nav-item">
				<a id="review" class="category-btn" data-category="review">대회정보후기</a>
			</div>
			<div class="nav-item">
				<a id="recommend" class="category-btn" data-category="recommend">러닝코스추천</a>
			</div>
			<div class="nav-item">
				<a id="mate" class="category-btn" data-category="mate">러닝메이트소모임</a>
			</div>
			<div class="nav-item">
				<a id="useditem" class="category-btn" data-category="useditem">중고거래</a>
			</div>
			<div class="nav-item">
				<a id="trainshare" class="category-btn" data-category="trainshare">훈련일지/목표공유</a>
			</div>
			<div class="nav-item">
				<a id="qa" class="category-btn" data-category="qa">Q&A/자유게시판</a>
			</div>
		</nav>
	</div>

	<!-- 검색창 -->
	<form id="searchForm">
		<div id="search-container">
			<div id="search-box">
				<input id="input_search" class="input_search" placeholder="관심있는 키워드를 검색하세요." name="search">
			</div>
			<button id="search-button" type="submit">
				<svg xmlns="http://www.w3.org/2000/svg" width="50" height="30" fill="currentColor" class="bi bi-search"
					viewBox="0 0 16 16">
					<path
						d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0" />
				</svg>
			</button>
		</div>
	</form>

	<!-- 글쓰기 버튼 -->
	<div id="upload-button">
		<!-- 비회원 로그인 alert창 안내용-->
		<input type="hidden" id="alertLogin" th:value="${alertLogin}">
		<a th:href="@{/community/post(category=${category}, search=${search})}" class="upload-button">글쓰기</a>
	</div>

	<!-- 게시글 리스트 부분-->
	<div id="list-container">
		<div th:fragment="postItems">

			<div th:each="item : ${list}" class="list-item" th:classappend="${item.isAdmin == 1} ? ' admin-post' : ''">
				<a class="PostDetailPath"
					th:href="@{/community/detail/{id}(id=${item.id}, category=${category}, search=${search})}">
					<div class="list-box">
						<div class="list-header">
						<div class="list-category" th:text="${item.category}">카테고리</div>
						<div class="list-date" th:text="${#temporals.format(item.inDate, 'yyyy-MM-dd')}">2025.11.18</div>
						</div>
							<div class="list-username" th:text="'러너: '+ ${item.nickName} + ' 님'">러너: 오늘도달려 님</div>

						<div class="list-title" th:text="${item.title}">오늘 10km 완주했어요!</div>

						<div class="reaction">
							<div class="likes" th:text="${item.countLikes > 0} ? '좋아요 ' + ${item.countLikes} : '좋아요 0'">
								🤍 좋아요</div>
							<div class="comment"
								th:text="${item.countComments > 0} ? '댓글 ' + ${item.countComments} : '댓글 0'">
								<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
									class="bi bi-chat" viewBox="0 0 16 16">
									<path
										d="M2.678 11.894a1 1 0 0 1 .287.801 11 11 0 0 1-.398 2c1.395-.323 2.247-.697 2.634-.893a1 1 0 0 1 .71-.074A8 8 0 0 0 8 14c3.996 0 7-2.807 7-6s-3.004-6-7-6-7 2.808-7 6c0 1.468.617 2.83 1.678 3.894m-.493 3.905a22 22 0 0 1-.713.129c-.2.032-.352-.176-.273-.362a10 10 0 0 0 .244-.637l.003-.01c.248-.72.45-1.548.524-2.319C.743 11.37 0 9.76 0 8c0-3.866 3.582-7 8-7s8 3.134 8 7-3.582 7-8 7a9 9 0 0 1-2.347-.306c-.52.263-1.639.742-3.468 1.105" />
								</svg>
								댓글
							</div>
						</div>
					</div>
				</a>
			</div>
		</div>
	</div>

	<hr>

	<!-- 바닥글-->
	<footer>
		<div id="footer">
			<p>개발자 : 김지영</p>
		</div>
	</footer>
</body>

</html>

<script>
	// 로그인 안 했을 경우 alert 띄우기
	const alertLogin = document.getElementById('alertLogin')?.value;
	if (alertLogin) alert("로그인이 필요합니다.");

	const ListModule = (function () {
		const container = document.getElementById('list-container');
		const currentCategoryInput = document.getElementById('currentCategory');
		const searchInput = document.getElementById('input_search');
		const searchForm = document.getElementById('searchForm');

		// 공통 fetch 함수
		async function fetchList(url) {
			try {
				const res = await fetch(url, {
					method: 'GET',
					headers: {
						"X-Requested-With": "XMLHttpRequest"
					}
				});
				const html = await res.text();
				const temp = document.createElement('div');
				temp.innerHTML = html;
				const items = temp.querySelectorAll('.list-item'); // fragment 안의 실제 item만 선택
				return {html, items};
			} catch (err) {
				console.error('게시글 로드 실패:', err);
				return {html: '', items: []};
			}
		}

		// 카테고리 버튼 클릭
		async function loadCategory(category) {
			if (currentCategoryInput) currentCategoryInput.value = category;
			const url = `/community/list?category=${encodeURIComponent(category)}`;
			const {html, items} = await fetchList(url);

			container.innerHTML = '';
			items.forEach(item => container.insertAdjacentHTML('beforeend', item.outerHTML));
		}

		// 검색 로직
		function search(event) {
			event.preventDefault(); // submit 기본동작 막기

			const searchValue = searchInput.value.trim();
			if (searchValue === '') {
				alert("검색어를 입력하세요.");
				return;
			}

			const url = `/community/list?search=${encodeURIComponent(searchValue)}`;

			fetchList(url).then(({html, items}) => {
				container.innerHTML = '';

				if (items.length === 0) {
					alert("검색 결과가 없습니다.");
					return;
				}

				// list-item만 append
				items.forEach(item => {
					container.insertAdjacentHTML('beforeend', item.outerHTML);
				});
			});
		}

		// 초기화: 이벤트 핸들러 연결
		function init() {
			if (searchForm) searchForm.addEventListener('submit', search);
			document.querySelectorAll('.category-btn').forEach(btn => {
				btn.addEventListener('click', () => loadCategory(btn.dataset.category));
			});
		}

		return {init};
	})();

	// DOM 준비 후 초기화
	document.addEventListener("DOMContentLoaded", () => ListModule.init());
</script>