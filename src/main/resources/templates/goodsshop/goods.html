<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Document</title>
	<style>
		

		

		.store-nav {
		    float: right;
		}

		table {
			border: solid 1px black;
			width: 150px;
			float: left;
			margin-right: 10px;
		}

		select {
			text-align: right;
			float: right;
		}

		#goodslist {
		    margin-left: 180px;
		    width: calc(100% - 180px);
		    display: flex;
		    flex-wrap: wrap;
		    gap: 20px;
		}

		.goods {
			flex: 0 0 calc(45% - 30px);
			/* 3ì—´ ë ˆì´ì•„ì›ƒ */
			display: flex;
			gap: 10px;
			border: 1px solid #ccc;
			padding: 10px;
			border-radius: 5px;
			background-color: #f9f9f9;
		}

		img {
			width: 150px;
			height: 150px;
			object-fit: cover;
			border: 1px solid #ccc;
			border-radius: 5px;
		}

		#basketbtn:hover {
			background-color: black;
		}

		#basketbtn img {
			width: 30px;
			height: 30px;
		}

		#jeokyongbtn {
			float: right;
		}

		#topRanking {
			display: flex;
			justify-content: center;
			gap: 20px;
			margin-bottom: 20px;
		}

		.rankingBox {
			display: flex;
			flex-direction: column;
			align-items: center;
			gap: 5px;
		}

		.rankLabel {
			font-size: 18px;
			font-weight: bold;
			color: #444;
		}

		.ranking {
			width: 200px;
			height: 200px;
			border: 1px solid black;
			border-radius: 10px;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 28px;
			font-weight: bold;
			background-color: #fff8d1;
		}

		.modal {
			display: none;
			position: fixed;
			z-index: 1000;
			left: 0;
			top: 0;
			width: 100%;
			height: 100%;
			overflow: auto;
			background-color: rgba(0, 0, 0, 0.5);
		}

		.modal-content {
			background-color: #fff;
			margin: 10% auto;
			padding: 20px;
			border-radius: 10px;
			width: 400px;
			text-align: center;
			position: relative;
		}

		.close {
			position: absolute;
			top: 10px;
			right: 15px;
			font-size: 28px;
			font-weight: bold;
			cursor: pointer;
		}

		.close:hover {
			color: red;
		}

		.cart-modal {
			display: none;
			position: fixed;
			z-index: 999;
			left: 0;
			top: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.3);
		}

		/* ëª¨ë‹¬ ë°•ìŠ¤ */
		.cart-modal-content {
			background: #fff;
			width: 350px;
			margin: 100px auto;
			padding: 20px;
			border-radius: 8px;
			position: relative;
		}

		.cart-close {
			position: absolute;
			top: 10px;
			right: 15px;
			font-size: 28px;
			font-weight: bold;
			cursor: pointer;
		}

		#cartItems div {
			padding: 8px 0;
			border-bottom: 1px solid #ddd;
		}

		.cart-footer {
			margin-top: 20px;
			padding-top: 10px;
		}

		#cartModal .close {
			position: absolute;
			top: 10px;
			right: 15px;
			font-size: 26px;
			font-weight: bold;
			cursor: pointer;
		}

		#cartModal .close:hover {
			color: red;
		}

		#checkoutBtn {
			width: 100%;
			padding: 10px;
			font-size: 16px;
			font-weight: bold;
			background-color: black;
			color: white;
			border: none;
			border-radius: 5px;
			cursor: pointer;
		}
		#adminbtn{
			background-color: red;
		}
	</style>
</head>

<body>

		<div th:replace="fragment/header :: headerDiv"></div>
		
	
	
		<nav class="store-nav">
			<div id="loginArea">

						    <!-- ğŸ”¹ ë¡œê·¸ì¸ ì•ˆ ë˜ì–´ ìˆì„ ë•Œ -->
						    <!--<div th:if="${session.loginUser == null}">
						        <input type="text" id="userId" placeholder="ì•„ì´ë”” ì…ë ¥">
						        <input type="password" id="userPw" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
						        <button onclick="login()">ë¡œê·¸ì¸</button>
						    </div> -->

						    <!-- ğŸ”¹ ë¡œê·¸ì¸ ë˜ì–´ ìˆì„ ë•Œ -->
						    <div th:if="${session.loginUser != null}">
						        <!-- <b th:text="${session.loginUser.userId}"></b> ë‹˜ ì–´ì„œì˜¤ì„¸ìš”! -->

						        <!-- ê´€ë¦¬ì -->
								<button th:if="${session.loginUser != null and session.loginUser.isAdmin == 1}"
								        onclick="location.href='/store/admin'" id="adminbtn">
								    ê´€ë¦¬ì í˜ì´ì§€
								</button>
								<!--<button th:if="${session.loginUser != null}"
								        onclick="location.href='/storelogout'">
								    ë¡œê·¸ì•„ì›ƒ
								</button> -->
						    </div>

						</div>
				<div>
			<input type="text" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”" id="search">
			<button id="searchBtn">ê²€ìƒ‰</button>
			<button id="basketbtn">
				<img
					src="https://w7.pngwing.com/pngs/742/249/png-transparent-shopping-cart-bag-shopping-cart-thumbnail.png">
			</button>
			<div id="cartModal" class="cart-modal">
			    <div class="cart-modal-content">
			        <span id="closeCart" class="close">&times;</span>
			        <h2>ì¥ë°”êµ¬ë‹ˆ</h2>

			        <!-- ì¥ë°”êµ¬ë‹ˆ ì•„ì´í…œ ë¦¬ìŠ¤íŠ¸ -->
			        <div id="cartItems">
			            <!-- ì˜ˆì‹œ: ì‹¤ì œë¡œëŠ” JSë¡œ ë™ì ìœ¼ë¡œ ì¶”ê°€ -->
			            <div class="cart-item" data-id="123" data-name="ìƒí’ˆA" data-quantity="2">
			                ìƒí’ˆA - ìˆ˜ëŸ‰: 2
			            </div>
			            <div class="cart-item" data-id="124" data-name="ìƒí’ˆB" data-quantity="1">
			                ìƒí’ˆB - ìˆ˜ëŸ‰: 1
			            </div>
			        </div>

			        <div class="cart-footer">
			            <strong>ì´ ê¸ˆì•¡: <span id="cartTotal">0</span> ì›</strong>
			            <br><br>
			            <button id="openPaymentFormBtn">ê²°ì œí•˜ê¸°</button>

			            <!-- ê³ ê°ì •ë³´ í¼ (ê¸°ë³¸ ìˆ¨ê¹€) -->
			            <div id="paymentForm" style="display:none; margin-top:15px;">
			                <h4>ê²°ì œ ì •ë³´ ì…ë ¥</h4>
			                <input type="text" id="payerName" placeholder="ì´ë¦„">
			                <input type="text" id="payerAddress" placeholder="ì£¼ì†Œ">
			                <input type="text" id="payerPhone" placeholder="ì „í™”ë²ˆí˜¸">
			                <button id="finalPayBtn">ìµœì¢… ê²°ì œí•˜ê¸°</button>
			            </div>
			        </div>
			    </div>
			</div>
		</nav>
	</div>
	<table>
		<thead>
			<tr>
				<th>í•„í„°</th>
			</tr>
		</thead>
		<tbody>
			<tr>
				<td>ì¢…ë¥˜
					<select id="filterTag"> <!-- ê¸°ì¡´ filterType â†’ filterTag -->
						<option value="">ì„ íƒì•ˆí•¨</option>
						<option th:each="tag : ${tagList}" th:value="${tag}" th:text="${tag}"></option>
					</select>
				</td>
			</tr>
			<tr>
				<td>ë¸Œëœë“œ
					<select id="filterBrand">
						<option value="">ì„ íƒì•ˆí•¨</option>
						<option th:each="brand : ${brandList}" th:value="${brand}" th:text="${brand}"></option>
					</select>
				</td>
			</tr>
			<tr>
				<td>ê°€ê²©ëŒ€, <span id="priceText">150,000</span>ì›
					<input class="range" id="priceRange" type="range" min="0" max="300000" step="5000" value="150000" />
				</td>
			</tr>
			<tr>
				<td>
					<input type="button" value="ì ìš©" id="jeokyongbtn">
					<input type="button" value="ì´ˆê¸°í™”" id="resetbtn">
				</td>
			</tr>
		</tbody>
	</table>

	<div id="topRanking" th:if="${topGoodsList != null and !#lists.isEmpty(topGoodsList)}">
		<div class="rankingBox" th:each="goods, iterStat : ${topGoodsList}">
			<div class="rankLabel" th:text="'TOP' + ${iterStat.index + 1}">TOP1</div>
			<div class="ranking">
				<img th:if="${goods != null and goods.goodsImage != null}" th:src="@{${goods.goodsImage}}"
					th:alt="${goods.goodsName}" style="width: 200px; height: 200px;">
				<span th:if="${goods == null or goods.goodsImage == null}"
					th:text="${goods != null ? goods.goodsName : 'ìƒí’ˆ ì •ë³´ ì—†ìŒ'}">ìƒí’ˆëª…</span>
			</div>
		</div>
	</div>

	<div id="goodslist">
		<div class="goods" th:each="goods : ${goodsList}">

			<!-- goodsê°€ nullì¸ ê²½ìš° ì „ì²´ ë¸”ë¡ ìˆ¨ê¹€ -->
			<div th:if="${goods != null}" style="display:flex; gap:15px; width:100%;">

				<!-- ì´ë¯¸ì§€ -->
				<img th:if="${goods.goodsImage != null}" th:src="@{${goods.goodsImage}}" alt="ìƒí’ˆ ì´ë¯¸ì§€">

				<img th:if="${goods.goodsImage == null}" src="/images/placeholder.png" alt="ì´ë¯¸ì§€ ì—†ìŒ">

				<!-- ìƒí’ˆ ì •ë³´ -->
				<div style="display: flex; flex-direction: column; gap: 5px; flex-grow: 1;">

					<div>
						<strong>ìƒí’ˆëª…:</strong>
						<span th:text="${goods.goodsName != null ? goods.goodsName : 'ì •ë³´ ì—†ìŒ'}"></span>
					</div>

					<div>
						<strong>ë¸Œëœë“œ:</strong>
						<span th:text="${goods.goodsBrand != null ? goods.goodsBrand : 'ì •ë³´ ì—†ìŒ'}"></span>
					</div>

					<div>
						<strong>ê°€ê²©:</strong>
						<span
							th:text="${goods.goodsPrice != null ? #numbers.formatDecimal(goods.goodsPrice, 0, 'COMMA', 0, 'POINT') + 'ì›' : '0ì›'}"></span>
					</div>

					<div>
						<strong>ìˆ˜ëŸ‰:</strong>
						<span th:text="${goods.goodsQuantity != null ? goods.goodsQuantity : 0}"></span>
					</div>

					<div>
						<strong>íƒœê·¸:</strong>
						<span th:text="${goods.goodsTag != null ? goods.goodsTag : '-'}"></span>
					</div>

					<div>
						<strong>ì„¤ëª…:</strong>
						<span th:text="${goods.goodsInfo != null ? goods.goodsInfo : '-'}"></span>
					</div>

					<div style="display: flex; justify-content: flex-end;">
						<button class="add-to-cart-btn" th:data-id="${goods.goodsId}" th:data-name="${goods.goodsName}"
							th:data-price="${goods.goodsPrice}">
							ë‹´ê¸°
						</button>
					</div>

				</div>
			</div>
		</div>
	</div>

	<script>
		const priceRange = document.getElementById("priceRange");
		const priceText = document.getElementById("priceText");

		priceRange.addEventListener("input", function () {
			priceText.textContent = Number(priceRange.value).toLocaleString();
		});

		/* -----------------------------
		   ì¥ë°”êµ¬ë‹ˆ ê¸°ëŠ¥
		------------------------------ */

		const cart = [];

		const basketBtn = document.getElementById("basketbtn");   // ì¥ë°”êµ¬ë‹ˆ ì•„ì´ì½˜ ë²„íŠ¼
		const cartModal = document.getElementById("cartModal");   // ëª¨ë‹¬
		const closeCart = document.getElementById("closeCart");   // ë‹«ê¸° ë²„íŠ¼

		// ì¥ë°”êµ¬ë‹ˆ ëª¨ë‹¬ ì—´ê¸°
		basketBtn.addEventListener("click", () => {
			cartModal.style.display = "block";
			renderCart(); // ëª¨ë‹¬ ì—´ë¦´ ë•Œ ìµœì‹  ëª©ë¡ ì¶œë ¥
		});

		// ëª¨ë‹¬ ë‹«ê¸°
		closeCart.addEventListener("click", () => {
			cartModal.style.display = "none";
		});

		window.addEventListener("click", (e) => {
			if (e.target === cartModal) {
				cartModal.style.display = "none";
			}
		});

		// "ë‹´ê¸°" ë²„íŠ¼ ì´ë²¤íŠ¸ ë“±ë¡
		document.querySelectorAll(".add-to-cart-btn").forEach(btn => {
			btn.addEventListener("click", () => {
				const id = btn.dataset.id;
				const name = btn.dataset.name;
				const price = parseInt(btn.dataset.price);

				let item = cart.find(x => x.id === id);

				if (item) {
					item.qty++;
				} else {
					cart.push({id, name, price, qty: 1});
				}

				alert("ì¥ë°”êµ¬ë‹ˆì— ë‹´ì•˜ìŠµë‹ˆë‹¤!");
			});
		});

		// ì¥ë°”êµ¬ë‹ˆ ëª©ë¡ ì¶œë ¥
		function renderCart() {
			const container = document.getElementById("cartItems");
			container.innerHTML = "";

			let total = 0;

			cart.forEach((item, index) => {
				total += item.price * item.qty;

				container.innerHTML += `
		            <div style="display:flex; justify-content:space-between; align-items:center;">
		                <div>
		                    ${item.name}  
		                    <br>
		                    <small>${(item.price * item.qty).toLocaleString()} ì›</small>
		                </div>

		                <div>
		                    <button class="qty-btn" data-index="${index}" data-type="minus">-</button>
		                    <span style="margin: 0 8px;">${item.qty}</span>
		                    <button class="qty-btn" data-index="${index}" data-type="plus">+</button>
		                </div>
		            </div>
		        `;
			});

			document.getElementById("cartTotal").innerText = total.toLocaleString();

			// ìˆ˜ëŸ‰ ì¡°ì ˆ ë²„íŠ¼ ì´ë²¤íŠ¸ ë“±ë¡
			document.querySelectorAll(".qty-btn").forEach(btn => {
				btn.addEventListener("click", () => {
					const index = btn.dataset.index;
					const type = btn.dataset.type;

					if (type === "plus") {
						cart[index].qty++;
					} else if (type === "minus") {
						cart[index].qty--;
						if (cart[index].qty <= 0) {
							cart.splice(index, 1); // ìˆ˜ëŸ‰ 0ì´ë©´ ì‚­ì œ
						}
					}

					renderCart(); // ë‹¤ì‹œ ë Œë”ë§
				});
			});
		}
		const searchInput = document.getElementById("search");
		const searchBtn = document.getElementById("searchBtn");


		// ê²€ìƒ‰ ì‹¤í–‰ í•¨ìˆ˜
		function searchGoods() {
			const goodsList = document.querySelectorAll(".goods");
			const keyword = searchInput.value.trim().toLowerCase();

			goodsList.forEach(goods => {
				const name = goods.querySelector("div strong + span").innerText.toLowerCase();

				// ê²€ìƒ‰ì–´ í¬í•¨ â†’ ë³´ì—¬ì£¼ê¸°
				if (name.includes(keyword) || keyword === "") {
					goods.style.display = "flex";
				} else {
					goods.style.display = "none";
				}
			});
		}

		// ì—”í„° ì…ë ¥ ì‹œ ê²€ìƒ‰
		searchInput.addEventListener("keypress", (e) => {
			if (e.key === "Enter") {
				searchGoods();
			}
		});

		// ë²„íŠ¼ í´ë¦­ ì‹œ ê²€ìƒ‰
		searchBtn.addEventListener("click", searchGoods);
		document.addEventListener('DOMContentLoaded', () => {
			const priceRange = document.getElementById('priceRange');
			const priceText = document.getElementById('priceText');
			const jeokyongbtn = document.getElementById('jeokyongbtn');
			const resetbtn = document.getElementById('resetbtn');

			priceRange.addEventListener('input', () => {
				priceText.textContent = Number(priceRange.value).toLocaleString();
			});

			jeokyongbtn.addEventListener('click', (event) => {
				event.preventDefault(); // í¼ ì œì¶œ ë§‰ê¸°

				const tag = document.getElementById('filterTag').value;
				const brand = document.getElementById('filterBrand').value;
				const maxPrice = priceRange.value;

				let url = '/store?';
				const params = [];
				if (tag) params.push('category=' + encodeURIComponent(tag));
				if (brand) params.push('brand=' + encodeURIComponent(brand));
				params.push('minPrice=0');
				params.push('maxPrice=' + encodeURIComponent(maxPrice));

				url += params.join('&');
				window.location.href = url;
			});

			resetbtn.addEventListener('click', () => {
				window.location.href = '/store';
			});
		});
		function renderGoods(goodsList) {
			const container = document.getElementById("goodslist");
			container.innerHTML = ""; // ê¸°ì¡´ ìƒí’ˆ ì œê±°

			goodsList.forEach(goods => {
				container.innerHTML += `
		        <div class="goods">
		            <img src="${goods.goodsImage}" alt="ìƒí’ˆ ì´ë¯¸ì§€">
		            <div style="display:flex; flex-direction:column; gap:5px;">
		                <div><strong>ìƒí’ˆëª…:</strong> ${goods.goodsName}</div>
		                <div><strong>ë¸Œëœë“œ:</strong> ${goods.goodsBrand}</div>
		                <div><strong>ê°€ê²©:</strong> ${goods.goodsPrice.toLocaleString()}ì›</div>
		                <div><strong>ìˆ˜ëŸ‰:</strong> ${goods.goodsQuantity}</div>
		                <div><strong>íƒœê·¸:</strong> ${goods.goodsTag}</div>
		                <div><strong>ì„¤ëª…:</strong> ${goods.goodsInfo}</div>
		                <button class="add-to-cart-btn"
		                    data-id="${goods.goodsId}"
		                    data-name="${goods.goodsName}"
		                    data-price="${goods.goodsPrice}">
		                    ë‹´ê¸°
		                </button>
		            </div>
		        </div>
		        `;
			});

			// ë‹¤ì‹œ "ë‹´ê¸°" ì´ë²¤íŠ¸ ì—°ê²°
			document.querySelectorAll(".add-to-cart-btn").forEach(btn => {
				btn.addEventListener("click", () => {
					const id = btn.dataset.id;
					const name = btn.dataset.name;
					const price = parseInt(btn.dataset.price);

					const item = cart.find(x => x.id === id);

					if (item) item.qty++;
					else cart.push({id, name, price, qty: 1});

					alert("ì¥ë°”êµ¬ë‹ˆì— ë‹´ì•˜ìŠµë‹ˆë‹¤!");
					renderCart();
				});
			});
		}
		document.addEventListener('DOMContentLoaded', () => {
			const priceRange = document.getElementById('priceRange');
			const priceText = document.getElementById('priceText');
			const jeokyongbtn = document.getElementById('jeokyongbtn');
			const resetbtn = document.getElementById('resetbtn');

			// ê°€ê²© í‘œì‹œ ì—…ë°ì´íŠ¸
			priceRange.addEventListener('input', () => {
				priceText.textContent = Number(priceRange.value).toLocaleString();
			});

			// í•„í„° ì ìš©


			// ì´ˆê¸°í™” ë²„íŠ¼
			resetbtn.addEventListener('click', () => {
				window.location.href = '/store';
			});
		});
		// ì˜ˆì‹œ: ì¥ë°”êµ¬ë‹ˆì—ì„œ ì„ íƒëœ ìƒí’ˆ ì •ë³´ë¥¼ hiddenì— ì„¸íŒ…í•˜ëŠ” í•¨ìˆ˜
		    // ì‹¤ì œë¡œëŠ” "ë‹´ê¸°" ë²„íŠ¼ í´ë¦­ ì‹œ cart ë°°ì—´ì„ ë§Œë“¤ì—ˆìœ¼ë‹ˆ í•„ìš”ì— ë”°ë¼ ìˆ˜ì •
		    function setPaymentItem(goodsId, goodsName, quantity) {
		        document.getElementById('pf_goodsId').value = goodsId;
		        document.getElementById('pf_goodsName').value = goodsName;
		        document.getElementById('pf_quantity').value = quantity;
		    }

		    // ëª¨ë‹¬ì˜ "ê²°ì œí•˜ê¸°" ë²„íŠ¼ -> ê³ ê°ì •ë³´ í¼ ë…¸ì¶œ
		    document.getElementById('openPaymentFormBtn').addEventListener('click', function() {
		        document.getElementById('paymentForm').style.display = 'block';
		    });

			// ìµœì¢… ê²°ì œ
			document.getElementById('finalPayBtn').addEventListener('click', () => {
			    const buyer = document.getElementById('payerName').value.trim();
			    const address = document.getElementById('payerAddress').value.trim();
			    const phone = document.getElementById('payerPhone').value.trim();

			    if (!buyer || !address || !phone) {
			        alert('ëª¨ë“  ê³ ê° ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
			        return;
			    }

			    if (cart.length === 0) {
			        alert('ì¥ë°”êµ¬ë‹ˆì— ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.');
			        return;
			    }

			    const orderData = cart.map(item => ({
			        goodsId: parseInt(item.id),
			        goodsName: item.name,
			        quantity: item.qty,
			        buyer: buyer,
			        address: address,
			        phone: phone
			    }));

			    fetch('/order', {
			        method: 'POST',
			        headers: { 'Content-Type': 'application/json' },
			        body: JSON.stringify(orderData)
			    })
			    .then(resp => resp.text())
			    .then(result => {
			        if(result === 'success') {
			            alert('ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
			            cart.length = 0; // ì¥ë°”êµ¬ë‹ˆ ì´ˆê¸°í™”
			            renderCart();
			            document.getElementById('paymentForm').style.display = 'none'; // ëª¨ë‹¬ ë‹«ê¸°
			        } else {
			            alert('ê²°ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
			        }
			    })
			    .catch(err => {
			        console.error(err);
			        alert('ì„œë²„ ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
			    });
			});
			function openLogin() {
			    document.getElementById("loginForm").style.display = "block";
			}

			// â˜… ì‹¤ì œ ë¡œê·¸ì¸ API í˜¸ì¶œí•˜ëŠ” ë¶€ë¶„ â˜…
			// ì—¬ê¸°ì—ì„œ Spring Bootì˜ ì»¨íŠ¸ë¡¤ëŸ¬ë¡œ AJAX ì „ì†¡í•˜ë©´ ë¨
			function login() {
			    const form = document.createElement("form");
			    form.method = "POST";
			    form.action = "/storelogin";

			    const idField = document.createElement("input");
			    idField.type = "hidden";
			    idField.name = "userId";
			    idField.value = document.getElementById("userId").value;
			    form.appendChild(idField);

			    const pwField = document.createElement("input");
			    pwField.type = "hidden";
			    pwField.name = "password";
			    pwField.value = document.getElementById("userPw").value;
			    form.appendChild(pwField);

			    document.body.appendChild(form);
			    form.submit();
			}

			function goAdminPage() {
			    window.location.href = "/store/admin";   // ê´€ë¦¬ì í˜ì´ì§€ URL
			}
	</script>


</body>

</html>