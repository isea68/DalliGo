<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="com.human.dalligo.dao.JYListDAO">
	
	<resultMap id="ListResult" type="com.human.dalligo.vo.JYListVO">
		<!-- 수동으로 Mapping 처리 -->
		<id property="id" column="id"/>
		<result property="nickName" column="nick_name"/>
		<result property="isAdmin" column="is_admin"/>
		<result property="title" column="title"/>
		<result property="content" column="content"/>
		<result property="countLikes" column="count_likes"/>
		<result property="countComments" column="count_comments"/>
		<result property="inDate" column="in_date"/>
	</resultMap>
	
	<sql id="postListSelect">
	    p.id,
	    p.category,
	    p.title,
	    p.content,
	    p.in_date,
	    u.nick_name,
	    u.is_admin,
	    (SELECT COUNT(*) FROM post_likes WHERE post_id = p.id) AS count_likes,
	    (SELECT COUNT(*) FROM post_comments WHERE post_id = p.id) AS count_comments
	</sql>

	<!-- 전체 게시글 조회 -->
	<select id="selectAll" resultMap="ListResult">
	 	SELECT 
	 		<include refid="postListSelect"/>  <!-- refid: reference Id-->
	 	FROM post p JOIN user u ON p.user_fk = u.id
	 	ORDER BY 
	 		u.is_admin DESC, <!-- 관리자(1) 먼저 -->
	 		p.in_date DESC <!-- 최신글 우선-->
	</select>

	<!-- 카테고리 별 게시글 조회 -->
	<select id="selectAllByCategory" parameterType="String" resultMap="ListResult">
		SELECT 
			<include refid="postListSelect"/> 
		FROM post p JOIN user u ON p.user_fk = u.id
		WHERE p.category = #{category}
		ORDER BY p.in_date DESC
	</select>

	<!-- 검색어 게시글 조회 -->
	<select id="selectAllBySearch" parameterType="String" resultMap="ListResult">
		SELECT 
			<include refid="postListSelect"/> 
		FROM post p JOIN user u ON p.user_fk = u.id
		WHERE p.title LIKE CONCAT ('%', #{search}, '%')
		OR p.content LIKE CONCAT ('%', #{search}, '%')
		OR u.nick_name LIKE CONCAT ('%', #{search}, '%')
		ORDER BY p.in_date DESC
	</select>
	
</mapper>